<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
        Hell's Gate: Walking the PEB
    </title><link href="https://red4mber.github.io/ atom.xml" title="Red4mber's blog" rel=alternate type=application/atom+xml><link href=https://red4mber.github.io/main.css media=screen rel=stylesheet><script src=https://red4mber.github.io/elasticlunr.min.js></script><script src=https://red4mber.github.io/search_index.en.js></script><script src=https://red4mber.github.io/search.js></script><meta content="Nerdy hacker girl from france. I love breaking computers, rust programming and coding programs no one should ever run ^^ I just started this blog, so expect more coming soon :)" name=description><meta content="Nerdy hacker girl from france. I love breaking computers, rust programming and coding programs no one should ever run ^^ I just started this blog, so expect more coming soon :)" name=description><meta content="index, nofollow" name=robots><meta content="Red4mber's blog" property=og:title><meta content=article property=og:type><meta content=https://red4mber.github.io/posts/hells-gate/ property=og:url><meta content="Nerdy hacker girl from france. I love breaking computers, rust programming and coding programs no one should ever run ^^ I just started this blog, so expect more coming soon :)" property=og:description><meta content="Red4mber's blog" property=og:site_name><meta content="default-src 'self' ws://127.0.0.1:1024/; img-src 'self' https://*; script-src 'self'; style-src 'self'; font-src 'self'" http-equiv=Content-Security-Policy><body><header><div class=navbar><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://red4mber.github.io>Red4mber's blog</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/projects> <img alt=Projects height=15 src=/menu_icon/projects.png width=15> Projects</a></nav><nav class="socials nav-navs"><div class=search-container><input placeholder="üîé   Search" id=search type=search><div class=search-results><div class=search-results__items></div></div></div><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=content><main><article><div class=title><h2>Hell's Gate: Walking the PEB</h2><div class=meta>Posted on <time>2024-08-25</time><div class=post-tags><nav class="nav tags">üè∑: <a href=https://red4mber.github.io/tags/programming/>programming</a> ¬† <a href=https://red4mber.github.io/tags/windows/>windows</a> ¬† <a href=https://red4mber.github.io/tags/malware/>malware</a> ¬†</nav></div> ||<span> 8 minute read</span></div></div><h1>Table of Contents</h1><ul><li><a href=https://red4mber.github.io/posts/hells-gate/#introduction>Introduction</a> <ul><li><a href=https://red4mber.github.io/posts/hells-gate/#what-is-peb-walking>What is PEB Walking ?</a><li><a href=https://red4mber.github.io/posts/hells-gate/#the-first-step-getting-a-handle-to-ntdll>The First Step: Getting a handle to NTDLL</a></li><ul><li><a href=https://red4mber.github.io/posts/hells-gate/#the-code>The code</a></ul><li><a href=https://red4mber.github.io/posts/hells-gate/#parsing-the-pe-file>Parsing the PE file</a></li><ul><li><a href=https://red4mber.github.io/posts/hells-gate/#the-dos-header>The DOS header</a><li><a href=https://red4mber.github.io/posts/hells-gate/#the-nt-headers>The NT Headers</a></ul></ul></ul><section class=body><img height=350 src=/img/hell_gate/walking_peb.png><h1 id=introduction>Introduction</h1><h2 id=what-is-peb-walking>What is PEB Walking ?</h2><p>Remember in the blog post on syscalls when i said i would explain how to make your own <code>GetProcAddress</code> function ?<p>Well this is it folks, PEB Walking is the way to go.<p>The <code>PEB</code> or <code>Process Environment Block</code> is a very useful data structure that contains all kinds of information about our current process. That includes pointers to all the modules currently loaded, and thus their export table, which contains pointers to any function it exports.<p>Well this process i just described, of "walking" from pointer to pointer, is what we commonly call PEB Walking. It has, notably been described in this excellent paper from vx_underground :<blockquote><p><a href=https://vxug.fakedoma.in/papers/VXUG/Exclusive/HellsGate.pdf>Hell's Gate</a> <br> by smelly__vx (<a href=https://twitter.com/RtlMateusz>@RtlMateusz</a>) and am0nsec (<a href=https://twitter.com/am0nsec>@am0nsec</a>)</blockquote><p>The paper introduces this technique as a way to dynamically resolving Windows syscalls at runtime without relying on any static or hardcoded SSNs, and additionally provides the code to execute these syscalls.<p>In this post, I'm going to focus on the SSN resolving part of this technique, which can be divided in the following steps:<ul><li>first, we find a pointer to NTDLL<li>We then parse NTDLL's export table<li>Lastly we parse every syscall to retreive their SSN</ul><p>In essence, we are going to write our own <code>GetModuleHandle</code> and <code>GetProcAddress</code> functions.<h2 id=the-first-step-getting-a-handle-to-ntdll>The First Step: Getting a handle to NTDLL</h2><p>As I said earlier, the <code>Process Environment Block</code> hold the information we need. More specifically, at offset 0x18 in its <code>PEB_LDR_DATA *Ldr</code> field, which as you can see is a pointer to a structure named <code>PEB_LDR_DATA</code>.<p><code>PEB_LDR_DATA</code> holds a records of every loaded modules, which means the PE itself and all the DLLs it has loaded, which will always include NTDLL. <br> It contains three doubly-linked lists, <code>InLoadOrderModuleList</code>, <code>InMemoryOrderModuleList</code> and <code>InInitializationOrderModuleList</code>, which all contains entries for every loaded modules.<br> To access this record, we simply need to follow one of these linked lists until we find the module we are looking for.<p>So, if I summarize everything so far :<ul><li>From the PEB, we read a pointer to PEB_LDR_DATA<li>From the PEB_LDR_DATA , read the first element of the InMemoryOrderModuleList linked list<li>Flink (forward link) through each element of the list until we find NTDLL.dll's LIST_ENTRY<li>Read the pointer to the DLL's base</ul><p>Here is a quick (and inaccurate) diagram to explain all of this : <img src=/img/hell_gate/peb_walk.png><h3 id=the-code>The code</h3><h4 id=getting-a-pointer-to-the-peb>Getting a pointer to the PEB</h4><p>The address of the PEB is stored in the <code>Thread Environment Block</code>, which we can find in the gs register (and the fs register on 32-bit windows). We can directly read at the offset containing the pointer to the PEB using inline assembly, like so :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">get_peb_address</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-modifier z-rust">*const</span> PEB</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
    <span class="z-storage z-type z-rust">let</span> peb_ptr<span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-support z-macro z-rust">asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov {}, gs:[0x60]<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">out</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>reg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> peb_ptr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
    peb_ptr  
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>Then, we just have to dereference the PEB structure to access any field we want. <br> Here's code that access the LDR Data Table and start going from link to link :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> peb<span class="z-punctuation z-separator z-rust">:</span> <span class="z-constant z-other z-rust">PEB</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-support z-function z-rust">get_peb_address</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-storage z-type z-rust">let</span> peb_loader_data <span class="z-keyword z-operator z-assignment z-rust">=</span>  peb<span class="z-punctuation z-accessor z-dot z-rust">.</span>Ldr<span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-storage z-type z-rust">let</span> first_entry <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>peb_loader_data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>InMemoryOrderModuleList<span class="z-punctuation z-accessor z-dot z-rust">.</span>Flink<span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-storage z-type z-rust">let</span> second_entry <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>first_entry</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>Flink<span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-storage z-type z-rust">let</span> third_entry <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>second_entry</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>Flink<span class="z-punctuation z-terminator z-rust">;</span>  
  
<span class="z-storage z-type z-rust">let</span> module_base <span class="z-keyword z-operator z-assignment z-rust">=</span> second_entry<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">byte_sub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x10</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-constant z-other z-rust">LDR_DATA_TABLE_ENTRY</span><span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>module_base</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>BaseDllName<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>module_base</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>FullDllName<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>The most important part here, and the most easy to miss, is the <code>.byte_sub(0x10)</code> This is because each Flink in the linked list do not point to the <em>LDR_DATA_TABLE_ENTRY</em>, but to the next <em>LIST_ENTRY</em> in the list. If you look at <em>LDR_DATA_TABLE_ENTRY</em> using the <code>dt</code> command in WinDgb, you'll see this that the InMemoryOrderLinks field is the second list in the layout, at offset 0x10.<pre class=z-code><code><span class="z-text z-plain">+0x000 InLoadOrderLinks : _LIST_ENTRY
+0x010 InMemoryOrderLinks : _LIST_ENTRY
+0x020 InInitializationOrderLinks : _LIST_ENTRY
+0x030 DllBase          : Ptr64 Void
....etc
</span></code></pre><p>So we need to offset it back by 16 bytes (0x10 in hex) to get the pointer to the start of the structure. We use InMemoryOrderLinks and not the other because <em>InLoadOrderLinks</em> and <em>InInitializationOrderLinks</em> are not defined in Windows crates, so unless you defined <em>LDR_DATA_TABLE_ENTRY</em> yourself (or just grabbed my own), you can not use those.<p>For your convenience, here is a nice function that does everything we just talked about :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">get_module_base_address</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">module_name</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-type z-rust">str</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-rust">*const</span> c_void, <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
    <span class="z-storage z-type z-rust">let</span> peb <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-support z-function z-rust">get_peb_address</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
    <span class="z-storage z-type z-rust">let</span> last_module <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>peb<span class="z-punctuation z-accessor z-dot z-rust">.</span>Ldr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>InMemoryOrderModuleList<span class="z-punctuation z-accessor z-dot z-rust">.</span>Blink<span class="z-punctuation z-terminator z-rust">;</span>  
    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> module_entry<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*mut</span> <span class="z-constant z-other z-rust">LIST_ENTRY</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>peb<span class="z-punctuation z-accessor z-dot z-rust">.</span>Ldr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>InMemoryOrderModuleList<span class="z-punctuation z-accessor z-dot z-rust">.</span>Flink<span class="z-punctuation z-terminator z-rust">;</span>  
    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> module_base<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-constant z-other z-rust">LDR_DATA_TABLE_ENTRY</span><span class="z-punctuation z-terminator z-rust">;</span>  
  
    <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
        module_base <span class="z-keyword z-operator z-assignment z-rust">=</span> module_entry<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">byte_sub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x10</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-constant z-other z-rust">LDR_DATA_TABLE_ENTRY</span><span class="z-punctuation z-terminator z-rust">;</span>  
        <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[?-?] Module : <span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>module_base</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>BaseDllName<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
        <span class="z-keyword z-control z-rust">if</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>module_base</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>BaseDllName<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">eq_ignore_ascii_case</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span> module_name </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
            <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[^-^] Module Found at address : {:x?}<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>module_base</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>DllBase<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
            <span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>module_base</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>DllBase</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>  
        <span class="z-keyword z-control z-rust">if</span> module_entry <span class="z-keyword z-operator z-comparison z-rust">==</span> last_module <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
            <span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Module not found !<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>  
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>  
  
        module_entry <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>module_entry</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>Flink<span class="z-punctuation z-terminator z-rust">;</span>  
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>  
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>Ta Daaa ~ <br> That's how you make DIY GetModuleAddress !<h2 id=parsing-the-pe-file>Parsing the PE file</h2><p>We may have the address of a loaded NTDLL module, but if we actually want those Syscall numbers, it is time to parse it. We must first understand its structure, and .<p>Here is my best attempt at a diagram: <br> (Yes really my best attempt TwT)</p><img height=550 src=/img/hell_gate/pe_format.png><p>If you want more information, here's a pretty good OSDev wiki article : <a href=https://wiki.osdev.org/PE>here</a><p>And there's the wikipedia article, which features way better diagram than mine :<br> <a href=https://en.wikipedia.org/wiki/Portable_Executable>https://en.wikipedia.org/wiki/Portable_Executable</a><h3 id=the-dos-header>The DOS header</h3><p>For historic reasons, every PE File contains a MS-DOS executable, called the <em>DOS Stub</em>. It contains a DOS Header and an actual MS-DOS program, that would simply output "This program cannot be run in DOS mode." in the case someone ran an exe file in a DOS environment.<p>Because it is the first bytes of the file, so we can easily read it by casting our pointer to the module to a pointer to the <em>IMAGE_DOS_HEADER</em> structure. We can then easily access it's fields by dereferencing it.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> dos_header_ptr <span class="z-keyword z-operator z-assignment z-rust">=</span> base_address <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-constant z-other z-rust">IMAGE_DOS_HEADER</span><span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-keyword z-control z-rust">if</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>dos_header_ptr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>e_magic <span class="z-keyword z-operator z-comparison z-rust">!=</span> <span class="z-constant z-other z-rust">IMAGE_DOS_SIGNATURE</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> 0x5A4D  
</span>    <span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Invalid DOS header<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>  
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>We are interested in only two fields of this structure:<ul><li><em>e_magic</em> which is the DOS Header signature and should always be <code>0x5A4D</code> (or "MZ")<li><em>e_lfanew</em> at offset 0x3C which contains an offset to the start of the NT Header</ul><h3 id=the-nt-headers>The NT Headers</h3><p>The NT Headers, or sometimes called <em>PE headers</em> or <em>COFF headers</em>, named after <em>Portable Executable</em> and <em>Common Object File Format</em>, can be found after the <em>DOS Stub</em>. <br> As with the DOS header, the first bytes are a signature, this time 4 bytes long, which should always be <code>0x00004550</code> or "PE\0\0" (PE followed by two null bytes).<br> This allows us to be sure we got the right address before dereferencing our structure.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> base_address <span class="z-keyword z-operator z-assignment z-rust">=</span> module_handle <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Get the offset to the NT headers from the PE header
</span><span class="z-storage z-type z-rust">let</span> nt_offset <span class="z-keyword z-operator z-assignment z-rust">=</span> base_address<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">byte_offset</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x03c</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Get a reference to the NT headers and check the signature
</span><span class="z-storage z-type z-rust">let</span> nt_header<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-constant z-other z-rust">IMAGE_NT_HEADERS</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>base_address
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">byte_offset</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>nt_offset <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">isize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">cast<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>IMAGE_NT_HEADERS<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">read</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-control z-rust">if</span> nt_header<span class="z-punctuation z-accessor z-dot z-rust">.</span>Signature <span class="z-keyword z-operator z-comparison z-rust">!=</span> <span class="z-constant z-other z-rust">IMAGE_NT_SIGNATURE</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">DllParserError<span class="z-punctuation z-accessor z-rust">::</span></span>InvalidNtHeader</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>The rest is split in two structures, the <em>File Header</em> and the <em>Optional Header</em>, which, in the case of Image files, is not at all optional <br><p>It's in fact in the Optional header that we'll find the data directory, which is our next target.<h4 id=the-data-directory>The data directory</h4><p>What we're really after is the last field of the optional header, named data directory. It is an array of <code>IMAGE_DATA_DIRECTORY</code> elements, each containing an address and a size.<p>The address is a <em>Relative Virtual Address</em> or RVA, meaning it's really an offset relative to the base of Image, just like the <code>e_lfanew</code> field in the DOS Header we saw earlier.<p>Each element in this array is a different directory, each containing various information such as the exports (index 0) and imports (index 1) the security directory, the exceptions etc....<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> export_dir<span class="z-punctuation z-separator z-rust">:</span> <span class="z-constant z-other z-rust">IMAGE_EXPORT_DIRECTORY</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> base_address
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">offset</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>nt_header<span class="z-punctuation z-accessor z-dot z-rust">.</span>OptionalHeader<span class="z-punctuation z-accessor z-dot z-rust">.</span>DataDirectory<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>VirtualAddress <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">isize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">cast<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>IMAGE_EXPORT_DIRECTORY<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">read</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>This export directory actually contains 3 different arrays<ul><li>AddressOfNames<li>AddressOfFunctions<li>AddressOfNameOrdinals</ul><p>These 3 arrays contains only adresses, but each of these addresses points to data we actually need, one to all the names, the other to function addresses, and the third, more cryptic one serve as an index to get the right address for the right name.<p>It should be easier to understand with some code, so here's the code used in my <a href=https://github.com/Red4mber/Thermite>Thermite</a> library to search a function's address by it's name :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> We're searching by name, so we iterate over the list of names
</span>   <span class="z-keyword z-control z-rust">for</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>i<span class="z-punctuation z-separator z-rust">,</span> name_addr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">in</span> address_of_names<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">iter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">enumerate</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
   	<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Then match over the result of CStr::from_ptr to capture eventual parsing errors
</span>   	<span class="z-keyword z-control z-rust">match</span> <span class="z-meta z-path z-rust">CStr<span class="z-punctuation z-accessor z-rust">::</span></span>from_ptr<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>module_handle <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span>name_addr <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-storage z-type z-rust">i8</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_str</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
   		<span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>s</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
   			<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> If it's ok, we test if our strings match
</span>   			<span class="z-keyword z-control z-rust">if</span> s<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">eq_ignore_ascii_case</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>function_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
   				<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> if it does, we return the address of the function
</span>   				<span class="z-storage z-type z-rust">let</span> rva <span class="z-keyword z-operator z-assignment z-rust">=</span> address_of_functions<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>address_of_name_ordinals<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>i<span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
   				<span class="z-storage z-type z-rust">let</span> true_address <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>module_handle <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> rva <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-terminator z-rust">;</span>
   				<span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>true_address</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
   			</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
   		</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
   		<span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
   			<span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">DllParserError<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionNameParsingError<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
   		</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
   	</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
   </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>Anyways I hope i've been clear enough, but if you manage to follow everything you should now be able to build a function like <code>GetProcAddress</code>.<p>I really invite you to go and check out the rest of the code in the github repo, as my explanations will never be enough to properly explain this.</section></article></main></div><footer><section><nav><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/Red4mber target=_blank> <img alt=github src=/social_icons/github.svg title=github> </a></nav><nav><span classname=desktop-only>This blog is powered by <a rel="noopener noreferrer" href=https://getzola.org/ target=_blank>Zola</a> with theme by <a rel="noopener noreferrer" href=https://syedzayyan.com/ target=_blank>SZM</a></span></nav></section><script src=https://red4mber.github.io/js/main.js></script></footer>