<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
        Introduction to syscalls
    </title><link href="https://red4mber.github.io/ atom.xml" title="Red4mber's blog" rel=alternate type=application/atom+xml><link href=https://red4mber.github.io/main.css media=screen rel=stylesheet><script src=https://red4mber.github.io/elasticlunr.min.js></script><script src=https://red4mber.github.io/search_index.en.js></script><script src=https://red4mber.github.io/search.js></script><meta content="Nerdy hacker girl from france. I love breaking computers, rust programming and coding programs no one should ever run ^^ I just started this blog, so expect more coming soon :)" name=description><meta content="Nerdy hacker girl from france. I love breaking computers, rust programming and coding programs no one should ever run ^^ I just started this blog, so expect more coming soon :)" name=description><meta content="index, nofollow" name=robots><meta content="Red4mber's blog" property=og:title><meta content=article property=og:type><meta content=https://red4mber.github.io/posts/syscalls/ property=og:url><meta content="Nerdy hacker girl from france. I love breaking computers, rust programming and coding programs no one should ever run ^^ I just started this blog, so expect more coming soon :)" property=og:description><meta content="Red4mber's blog" property=og:site_name><meta content="default-src 'self' ws://127.0.0.1:1024/; img-src 'self' https://*; script-src 'self'; style-src 'self'; font-src 'self'" http-equiv=Content-Security-Policy><body><header><div class=navbar><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://red4mber.github.io>Red4mber's blog</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/projects> <img alt=Projects height=15 src=/menu_icon/projects.png width=15> Projects</a></nav><nav class="socials nav-navs"><div class=search-container><input placeholder="üîé   Search" id=search type=search><div class=search-results><div class=search-results__items></div></div></div><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=content><main><article><div class=title><h2>Introduction to syscalls</h2><div class=meta>Posted on <time>2024-08-25</time><div class=post-tags><nav class="nav tags">üè∑: <a href=https://red4mber.github.io/tags/programming/>programming</a> ¬† <a href=https://red4mber.github.io/tags/windows/>windows</a> ¬† <a href=https://red4mber.github.io/tags/malware/>malware</a> ¬†</nav></div> ||<span> 11 minute read</span></div></div><h1>Table of Contents</h1><ul><li><a href=https://red4mber.github.io/posts/syscalls/#introduction>Introduction</a> <ul><li><a href=https://red4mber.github.io/posts/syscalls/#user-mode-vs-kernel-mode>User Mode vs Kernel Mode</a><li><a href=https://red4mber.github.io/posts/syscalls/#but-how>But How ??</a></ul><li><a href=https://red4mber.github.io/posts/syscalls/#system-service-numbers>System Service Numbers</a> <ul><li><a href=https://red4mber.github.io/posts/syscalls/#retrieving-the-system-service-numbers>Retrieving the System Service Numbers</a></li><ul><li><a href=https://red4mber.github.io/posts/syscalls/#hardcoding-ssns-in-a-lookup-table>Hardcoding SSNs in a lookup table</a></ul><li><a href=https://red4mber.github.io/posts/syscalls/#dynamic-retrieval-of-ssns>Dynamic Retrieval of SSNs</a></li><ul><li><a href=https://red4mber.github.io/posts/syscalls/#but-what-if-it-s-hooked>But what if it's hooked ?</a></ul></ul><li><a href=https://red4mber.github.io/posts/syscalls/#direct-syscalls>Direct Syscalls</a> <ul><li><a href=https://red4mber.github.io/posts/syscalls/#back-to-hardcoded-ssns>Back to hardcoded SSNs</a></ul></ul><section class=body><h1 id=introduction>Introduction</h1><h2 id=user-mode-vs-kernel-mode>User Mode vs Kernel Mode</h2><p>The x86 processor architecture provides multiple "rings" of privilege, numbered 0 to 3, called <strong>protection rings</strong>. Ring 3 has the least privilege while Ring 0 has complete access over the hardware of your computer. This allows your processor to avoid giving every program access to resources it doesn't need. In other words, it allows your processor to respect the <strong>Principle of Least Privilege</strong>.</p><img height=450 src=https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Priv_rings.svg/1280px-Priv_rings.svg.png><p>Most applications running on your computer run at Ring 3, while only the kernel of your operating system Ring 0. The Windows Operating System only uses Ring 0 and 3, to maintain compatibility with other architectures such as ARM, which only implement two protection modes, <strong>Kernel mode</strong> and <strong>User Mode</strong>. You see, your programs run in user mode but sometimes they need to do some fancy stuff that requires special permissions. That's where syscalls come in, acting as your middleman to request those privileged operations from the kernel, which runs in kernel mode.<h2 id=but-how>But How ??</h2><img height=240/ src=/img/syscalls/ICP_Syscalls.jpg><p>When you call a function like <em>WriteFile</em>, the windows API will then call the Native API, which will then call the syscall instruction for you, which will then put the processor in kernel mode and execute what you need. <br> Here's a handy image i shamelessly swiped from RedOps.at blog : <img alt="Transition from User mode to kernel mode - from RedOps.at" src=https://redops.at/assets/images/blog/notepad_transition_syscall.png> But most EDRs will hook these functions in ntdll.dll, and that no good for us malware developers, our code would probably trigger an alert. We need a way to call the syscall ourselves, hence bypassing any EDR hook in user space APIs.<p>To understand how to do this, let's take a look at a syscall from Ntdll.dll :<p><img alt=NtCreateFile_Syscall_Disassembled.png src=/img/syscalls/NtCreateFile_Syscall_Disassembled.png><p>The code of a syscall (also called the <code>syscall stub</code>) :<pre class="language-asm z-code" data-lang=asm><code class=language-asm data-lang=asm><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r10</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rcx</span><span class="z-comment z-assembly">	; Move the parameters in the r10 register</span>
<span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">eax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">55h</span><span class="z-comment z-assembly">	; Store the syscall ID in the EAX register </span>
<span class="z-keyword z-control z-assembly">syscall</span><span class="z-comment z-assembly">			; Switch to kernel mode</span>
<span class="z-keyword z-control z-assembly">ret</span><span class="z-comment z-assembly">				; return</span>
</span></code></pre><p>It moves "0x55" in the EAX register, then use the <em>syscall</em> instruction. Since <em>syscall</em> is a single instruction, this is how we identify what syscall is called. This number is called a <strong>System Service Number</strong> (or SSN).<p>Here, we have 0x55, the SSN for the <em>NtCreateFile</em> syscall - For Windows 10 and 11 x64.<blockquote><p>You might wonder what is the <code>test [7FFE0308]</code> instruction just before the syscall instruction.<br> On some legacy systems, the <code>syscall</code> instruction doesn't exist, instead need to use the interrupt 2E.<br> In the <code>KUSER_SHARED_DATA</code> structure (found at address 0x7FFE0000), there is a field called SystemCall at offset 0x0308, storing the type of system call the OS need to use. This check the value of this field, if it's not equal to 1, it jumps after the return and executes INT 2E.</blockquote><h1 id=system-service-numbers>System Service Numbers</h1><h2 id=retrieving-the-system-service-numbers>Retrieving the System Service Numbers</h2><p>Microsoft being Microsoft, you can forget about legit documentation for syscalls. Most legit programs don't need to call syscalls directly, the Windows API does that for them, but we aren't writing a legit program, so how do we find them ? Well there are multiple ways:<h3 id=hardcoding-ssns-in-a-lookup-table>Hardcoding SSNs in a lookup table</h3><p>You might just want to look them up and hardcode them in your program, but there a problem. As i said earlier, you are not supposed to call them yourself, the windows API does. This means all the syscalls are <strong>undocumented</strong> and the SSNs are very prone to change from a version of windows to another. It means that with poor luck, the SSN you find might only be valid for the version of windows you are currently running. However, some giga chads already did the work of dumping SSNs for most versions of windows, and put everything online for you to use in your code !~ <a href=https://j00ru.vexillium.org/syscalls/nt/64/>Windows X86-64 NT Syscall table by j00ru</a>.<h4 id=reading-build-number-from-the-peb>Reading build number from the PEB</h4><p>As said just above, you need precise version information to find the correct SSN, and there an easy way to do that. The <em>Process Environment Block</em> contains all the information we need. You can easily get the base address of the PEB structure at offset 0x60 in the gs register on 64-bits systems, and at offset 0x30 in the fs register for 32-bits systems. You can then find the build number at offset 0x0120 for 64 bits system and 0xAC for 32 bits systems. Here is an example in Rust :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">core<span class="z-punctuation z-accessor z-rust">::</span></span>ptr<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">core<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">arch<span class="z-punctuation z-accessor z-rust">::</span></span>asm<span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">get_build_number</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">u32</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">let</span> build_number<span class="z-punctuation z-separator z-rust">,</span> peb_address<span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">cfg</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">target_arch <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>x86_64<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
    <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
	    <span class="z-support z-macro z-rust">asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov {}, gs:[0x60]<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">out</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>reg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> peb_address</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        build_number <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ptr<span class="z-punctuation z-accessor z-rust">::</span></span>read<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>peb_address <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x0120</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    <span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">cfg</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">target_arch <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>x86<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
    <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
	    <span class="z-support z-macro z-rust">asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov {}, fs:[0x30]<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">out</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>reg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> peb_address</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        build_number <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ptr<span class="z-punctuation z-accessor z-rust">::</span></span>read<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>peb_address <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0xAC</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    build_number
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
	<span class="z-storage z-type z-rust">let</span> build_number <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-support z-function z-rust">get_build_number</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Build number: <span class="z-constant z-other z-placeholder z-rust">{build_number}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><h2 id=dynamic-retrieval-of-ssns>Dynamic Retrieval of SSNs</h2><p>A slightly more complicated way is to dynamically extract the SSN from the NTDLL library. All syscalls in Ntdll.dll have the exact same structure : <img alt=NtCreateFile_Syscall_Disassembled.png src=/img/syscalls/NtCreateFile_Syscall_Disassembled.png><p>Or, the actual bytes we care about :<pre class=z-code><code><span class="z-text z-plain">4C 8B D1
B8 ?? 00 00 00
...
0F 05
c3
</span></code></pre><p>The SSN we are looking for is the 5th byte of that procedure, so to read it, we just need to read 1 byte starting at the procedure address + 4.<p>Using the <code>GetProcAddress</code> function, we can get the address of any procedure in a module, then look 4 bytes after this address to get the SSN of that syscall :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">mem<span class="z-punctuation z-accessor z-rust">::</span></span>transmute<span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span>ptr<span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">windows<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">core<span class="z-punctuation z-accessor z-rust">::</span></span>s<span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">windows<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Win32<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">System<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">LibraryLoader<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>GetProcAddress<span class="z-punctuation z-separator z-rust">,</span> GetModuleHandleA</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
  
<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
    <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
        <span class="z-storage z-type z-rust">let</span> ntdll_handle <span class="z-keyword z-operator z-assignment z-rust">=</span> GetModuleHandleA<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">s!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>ntdll.dll<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap_or_else</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
            <span class="z-support z-macro z-rust">eprintln!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[-] Failed to get a handle on ntdll.dll: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
            <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">process<span class="z-punctuation z-accessor z-rust">::</span></span>exit<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">-</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
        <span class="z-storage z-type z-rust">let</span> ntcreatefile_ptr <span class="z-keyword z-operator z-assignment z-rust">=</span> GetProcAddress<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ntdll_handle<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-macro z-rust">s!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>NtCreateFile<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
        <span class="z-storage z-type z-rust">let</span> ntcreatefile_ptr<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">usize</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">transmute</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ntcreatefile_ptr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
        <span class="z-storage z-type z-rust">let</span> ntcreatefile_ssn <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ptr<span class="z-punctuation z-accessor z-rust">::</span></span>read<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ntcreatefile_ptr <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">4</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
        <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[+] NtCreateFile SSN : <span class="z-constant z-other z-placeholder z-rust">{:#04x}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> ntcreatefile_ssn<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> NtCreateFile SSN : 0x55   
</span>    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>  
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>For debugging, you can check your results against j00ru's <a href=https://j00ru.vexillium.org/syscalls/nt/64/>Windows X86-64 NT Syscall table</a>.<h3 id=but-what-if-it-s-hooked>But what if it's hooked ?</h3><p>However, there is a catch, this technique doesn't work if that syscall is hooked by an EDR, as we would have a jmp to the EDR hook as the first instruction, so the SSN would not be at offset +0x4 !<p>A quick and dirty way to mitigate this issue would be to first read the first byte, if it's a JMP instruction (0xE9), then skip at least the next 4 bytes (which would be the jump address). Here's a program detecting hooks and verifying the presence of the mov eax instruction to ensure the retrieval of the correct SSN :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span>ptr<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">mem<span class="z-punctuation z-accessor z-rust">::</span></span>transmute<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">windows<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">core<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-constant z-other z-rust">PCSTR</span><span class="z-punctuation z-separator z-rust">,</span> s</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">windows<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Win32<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Foundation<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">windows<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Win32<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">System<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">LibraryLoader<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>GetProcAddress<span class="z-punctuation z-separator z-rust">,</span> GetModuleHandleA</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">get_ssn</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">ntdll_handle</span><span class="z-punctuation z-separator z-rust">:</span> HMODULE, <span class="z-variable z-parameter z-rust">syscall_name</span><span class="z-punctuation z-separator z-rust">:</span> PCSTR</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">let</span> start_ptr <span class="z-keyword z-operator z-assignment z-rust">=</span> GetProcAddress<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ntdll_handle<span class="z-punctuation z-separator z-rust">,</span> syscall_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">let</span> start_ptr<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-storage z-type z-rust">u8</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">transmute</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>start_ptr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span> 

    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> We read 8 bytesfrom the syscall
</span>	<span class="z-keyword z-control z-rust">match</span> <span class="z-meta z-path z-rust">ptr<span class="z-punctuation z-accessor z-rust">::</span></span>read<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>start_ptr <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">*const</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-separator z-rust">;</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> If they match this pattern, we return them
</span>		<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x4c</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x8b</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0xd1</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0xb8</span><span class="z-punctuation z-separator z-rust">,</span> ssn_1<span class="z-punctuation z-separator z-rust">,</span> ssn_2<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x00</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-rust">0x00</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
			<span class="z-storage z-type z-rust">let</span> ssn <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ssn_2 <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u16</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust"><</span><span class="z-keyword z-operator z-comparison z-rust"><</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> ssn_1 <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u16</span><span class="z-punctuation z-terminator z-rust">;</span>
			<span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ssn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
		</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> In every other case, we failed :C
</span>		<span class="z-keyword z-operator z-rust">_</span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-support z-type z-rust">None</span>
	</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">let</span> ntdll_handle<span class="z-punctuation z-separator z-rust">:</span> <span class="z-constant z-other z-rust">HMODULE</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> GetModuleHandleA<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">s!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>ntdll.dll<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap_or_else</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">e</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-support z-macro z-rust">eprintln!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[-] Failed to get a handle on ntdll.dll: <span class="z-constant z-other z-placeholder z-rust">{e}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">process<span class="z-punctuation z-accessor z-rust">::</span></span>exit<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">-</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-keyword z-control z-rust">match</span> <span class="z-support z-function z-rust">get_ssn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ntdll_handle<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-macro z-rust">s!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>NtCreateFile<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ntcreatefile_ssn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[+] Found NtCreateFile SSN : <span class="z-constant z-other z-placeholder z-rust">{:#04x}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> ntcreatefile_ssn<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">process<span class="z-punctuation z-accessor z-rust">::</span></span>exit<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
            <span class="z-support z-type z-rust">None</span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-support z-macro z-rust">eprintln!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[-] SSN Not Found<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
                <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">process<span class="z-punctuation z-accessor z-rust">::</span></span>exit<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">-</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>Ideally, we would not use the <code>GetModuleHandleA</code> and <code>GetProcAddress</code> functions but that's for a later post, when we'll see how to implement Hell's Gate "PEB Walking" technique.<h1 id=direct-syscalls>Direct Syscalls</h1><h2 id=back-to-hardcoded-ssns>Back to hardcoded SSNs</h2><p>We finally have a way to recover the syscalls SSN, cool ! But we're gonna have to wait a little bit before doing everything dynamically. We're first going to make system calls with hardcoded SSNs to understand how everything works.<p>If you remember earlier in this post when I talked about extracting the build number from the PEB, you may have noticed i used a macro to run an arbitrary assembly instruction, to read the PEB address from a register.<p>We already saw the <code>asm!()</code> which allows us to run arbitrary instructions like so :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-support z-macro z-rust">asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov {}, gs:[0x60]<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">out</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>reg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> peb_addr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>Here, we moved the value at offset 0x60 in the gs register to another register, which will output to the <code>peb_addr</code> variable.<p>This is only a small example of what this powerful macro can do but there is a catch, we can't use this macro outside of a function scope.<p>To quote <a href=https://doc.rust-lang.org/nightly/reference/inline-assembly.html>The Rust Reference</a> :<blockquote><p>With the <code>asm!</code> macro, the assembly code is emitted in a function scope and integrated into the compiler-generated assembly code of a function.<p>This assembly code must obey <a href=https://doc.rust-lang.org/nightly/reference/inline-assembly.html#rules-for-inline-assembly>strict rules</a> to avoid undefined behavior.<br>Note that in some cases the compiler may choose to emit the assembly code as a separate function and generate a call to it.</blockquote><p>With the <code>global_asm!</code> macro, the assembly code is emitted in a global scope, outside a function. This can be used to hand-write entire functions using assembly code, and generally provides much more freedom to use arbitrary registers and assembler directives.<p>The <code>global_asm!</code> macro, however, can't take any variable as input and output, but this macro is <em>global</em>, meaning it is outside of any function's scope, we can define our own functions in assembly and use them in our rust code like any extern C library.<p>As an example, here's how to make a direct syscall to NtOpenProcess :<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Write the actual syscall in assembly
</span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> All syscalls have the same structure
</span><span class="z-support z-macro z-rust">global_asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-raw z-rust"><span class="z-storage z-type z-string z-rust">r</span><span class="z-punctuation z-definition z-string z-begin z-rust">#"</span>
.section .text
.global NtOpenProcess
NtOpenProcess:
		mov r10, rcx
		mov eax, 0x26
		syscall
		ret
<span class="z-punctuation z-definition z-string z-end z-rust">"#</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> We need to declare the signature of the extern function
</span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> To tell rust this function exists and how to use it
</span><span class="z-keyword z-other z-rust">extern</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>C<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">NtOpenProcess</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>  
        <span class="z-variable z-parameter z-rust">ProcessHandle</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*mut</span> HANDLE,  
        <span class="z-variable z-parameter z-rust">AccessMask</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>,  
        <span class="z-variable z-parameter z-rust">ObjectAttributes</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*const</span> OBJECT_ATTRIBUTES,  
        <span class="z-variable z-parameter z-rust">ClientId</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*const</span> CLIENT_ID,  
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> NTSTATUS</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>

<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Now we can use this function in our code o/
</span>status <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">syscalls<span class="z-punctuation z-accessor z-rust">::</span></span>NtOpenProcess<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> process_handle<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-other z-rust">PROCESS_ALL_ACCESS</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>oa<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>cid</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
<span class="z-keyword z-control z-rust">if</span> status <span class="z-keyword z-operator z-comparison z-rust">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>  
    <span class="z-support z-macro z-rust">eprintln!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>[TwT] Failed to open process: <span class="z-constant z-other z-placeholder z-rust">{status:#x}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
    <span class="z-meta z-path z-rust">process<span class="z-punctuation z-accessor z-rust">::</span></span>exit<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">-</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>  
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>You may need to import structures from windows libraries, but this is optional as you can also defined those yourself. You will notice the code of the syscall procedure is exactly the code we saw previously, in the chapter on dynamic SSN retrieval, but we added these two lines :<pre class=z-code><code><span class="z-text z-plain">.section .text
.global NtOpenProcess
</span></code></pre><p>The first line, <code>.section .text</code> will tell the compiler to assembled the following code into a section named <code>.text</code>. The <code>.text</code> section is usually the section of the code contaning executable instructions. The second line, <code>.global NtOpenProcess</code> is an export. The <code>global</code> keyword tells the linker that the <code>NtOpenProcess</code> symbol is global, and not just local to the assembly, this allows us to call the code from the rust code.<p>But this method is definitely not the best.... Not only we have to define the signature of every syscall we want to use in our code, but our assembly is only going to work for a single version of windows, because SSNs change all the time ! This is why we'll see in the nextblog post how to create them dynamically.<p>Some additionnal reading :<ul><li><p><a href=https://www.ired.team/offensive-security/defense-evasion/detecting-hooked-syscall-functions>Detecting Hooked Syscalls by ired.team</a></p><li><p><a href=https://www.crow.rip/crows-nest/mal/dev/inject/syscalls/direct-syscalls>Direct Syscalls by Crow</a> <a href="https://www.youtube.com/watch?v=-M2_mZg_2Ew">and his awesome video on the subject &LT3</a></p><li><p><a href=https://alice.climent-pommeret.red/posts/direct-syscalls-hells-halos-syswhispers2/>Alice Climent-Pommeret's excellent blog</a> <a href=https://alice.climent-pommeret.red/posts/a-syscall-journey-in-the-windows-kernel/>and this post too</a></p><li><p><a href=https://redops.at/en/blog/direct-syscalls-a-journey-from-high-to-low>RedOps blog post too</a> <a href=https://www.timdbg.com/posts/writing-a-debugger-from-scratch-part-4/>https://www.timdbg.com/posts/writing-a-debugger-from-scratch-part-4/</a></p><li><p><a href=https://offensivedefence.co.uk/posts/dinvoke-syscalls/>https://offensivedefence.co.uk/posts/dinvoke-syscalls/</a></p><li><p><a href=https://blog.lystic.dev/2023/05/30/manual-syscalls-on-windows/>https://blog.lystic.dev/2023/05/30/manual-syscalls-on-windows/</a> &LT3</p></ul></section></article></main></div><footer><section><nav><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/Red4mber target=_blank> <img alt=github src=/social_icons/github.svg title=github> </a></nav><nav><span classname=desktop-only>This blog is powered by <a rel="noopener noreferrer" href=https://getzola.org/ target=_blank>Zola</a> with theme by <a rel="noopener noreferrer" href=https://syedzayyan.com/ target=_blank>SZM</a></span></nav></section><script src=https://red4mber.github.io/js/main.js></script></footer>